<!DOCTYPE html>
<html lang="{{ session.get('lang','ar') }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</title>
  <style>
    body{font-family:system-ui,"Cairo",sans-serif;margin:0;background:#f7f7f9;
         direction: {{ 'rtl' if session.get('lang','ar')=='ar' else 'ltr' }};}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#111;color:#fff}
    header a{color:#9ad; text-decoration:none; margin-inline:8px}
    main{max-width:980px;margin:24px auto; padding:0 12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border:1px solid #e8e8ef;border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    h1,h2{margin:6px 0 12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
    .muted{opacity:.8;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{display:block;margin-bottom:4px;font-size:14px}
    input,select,button{padding:10px;border:1px solid #ddd;border-radius:8px;font:inherit}
    button{cursor:pointer}
    .top-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .lang{font-size:13px;opacity:.9}
    .ok{color:#1a7f37}.err{color:#b54708}
    .btns{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){.split{grid-template-columns:1fr 1fr}}
    .badge{display:inline-block;background:#eef;padding:2px 8px;border-radius:999px;font-size:12px}
    .warn{padding:8px;border:1px solid #f3c; background:#fff0f6;border-radius:10px}
    .btn-plain{border:1px solid #111;background:#111;color:#fff;border-radius:8px;padding:10px 12px}
    .btn-plain[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
<header>
  <div class="top-links">
    <a href="{{ url_for('index') }}">ğŸ  {{ t('home') if t else 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' }}</a>
    {% if session.get('is_admin') %}
      <a href="{{ url_for('admin_overview') }}">ğŸ›¡ï¸ {{ t('admin_panel') if t else 'Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' }}</a>
      <a href="{{ url_for('admin_withdrawals') }}">ğŸ’¸ {{ t('withdrawals') if t else 'Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨' }}</a>
    {% endif %}
  </div>
  <div class="top-links">
    <span class="lang">
      <a href="{{ url_for('set_lang', lang='ar', next=request.full_path) }}">{{ t('arabic') if t else 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' }}</a> |
      <a href="{{ url_for('set_lang', lang='en', next=request.full_path) }}">{{ t('english') if t else 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' }}</a>
    </span>
    <a href="{{ url_for('logout') }}">ğŸ”“ {{ t('logout') if t else 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬' }}</a>
  </div>
</header>

<main>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="card" aria-live="polite">
        {% for cat,msg in messages %}
          <div class="{{ 'ok' if cat=='success' else 'err' if cat=='error' else '' }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="grid">
    <!-- Ø§Ù„Ø±ØµÙŠØ¯ -->
    <section class="card">
      <h2>ğŸ’° Ø£Ø±ØµØ¯Ø© Ø­Ø³Ø§Ø¨Ùƒ</h2>
      <table>
        <thead><tr><th>Ø§Ù„Ø¹Ù…Ù„Ø©</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr></thead>
        <tbody>
          {% for cur,amt in (balances or {}).items() %}
          <tr><td>{{ cur }}</td><td>{{ '%.2f'|format(amt) }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="muted">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: {{ pending_withdrawals_count or 0 }}</p>
    </section>

    <!-- Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø£Ø®ÙŠØ±Ø© -->
    <section class="card">
      <h2>ğŸ“œ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h2>
      <table>
        <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ø¹Ù…Ù„Ø©</th></tr></thead>
        <tbody>
          {% for t in transactions %}
          <tr>
            <td>{{ t.timestamp }}</td>
            <td>{{ t.type }}</td>
            <td>{{ t.amount }}</td>
            <td>{{ t.currency }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </div>

  <!-- ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Øª -->
  <section class="card">
    <h2>ğŸ” ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Øª</h2>
    <form method="POST" action="{{ url_for('convert_balance') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row">
        <div>
          <label>Ù…Ù†</label>
          <select name="from_currency" required>
            {% for cur in supported %}<option value="{{ cur }}">{{ cur }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>Ø¥Ù„Ù‰</label>
          <select name="to_currency" required>
            {% for cur in supported %}<option value="{{ cur }}">{{ cur }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input type="number" name="amount" min="0" step="0.01" required>
        </div>
      </div>
      <div style="margin-top:10px">
        <button type="submit">ØªØ­ÙˆÙŠÙ„</button>
      </div>
    </form>
  </section>

  <!-- Ø´Ø­Ù† Ø¹Ø¨Ø± Binance Pay ÙÙ‚Ø· -->
  <section class="card">
    <h2>ğŸŸ¡ Binance Pay Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ (USDT / BTC)</h2>
    {% if not binance_enabled %}
      <div class="warn">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· Ù…ÙØ§ØªÙŠØ­ Binance Pay. Ø£Ø¶Ù <code>BINANCE_API_KEY</code> Ùˆ<code>BINANCE_API_SECRET</code> ÙÙŠ <code>.env</code>.</div>
    {% endif %}
    <div class="split">
      <form class="row" onsubmit="return false">
        <div>
          <label>Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</label>
          <select id="bp_crypto">
            <option value="USDT">USDT</option>
            <option value="BTC">BTC</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¯ÙØ¹Ù‡</label>
          <input type="number" id="bp_amount" min="0.5" step="0.00000001" required>
        </div>
      </form>
      <div>
        <span class="badge">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù„Ù‰ ØµÙØ­Ø© Binance Ø§Ù„Ø¢Ù…Ù†Ø©</span>
        <div class="btns" style="margin-top:10px">
          <button id="binance-pay" type="button" class="btn-plain" {{ 'disabled' if not binance_enabled else '' }}>ğŸŸ¡ Ø§Ø¯ÙØ¹ Ø¹Ø¨Ø± Binance Pay</button>
        </div>
        <p class="muted">Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹ Ø³ØªØ¹ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ù…ÙˆÙ‚Ø¹ØŒ ÙˆØ³ÙŠÙØ¶Ø§Ù Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (USDTâ‰ˆUSDØŒ ÙˆBTC ÙŠÙØ­ÙˆÙ‘Ù„ Ø¨Ø³Ø¹Ø± Ù„Ø­Ø¸ÙŠ).</p>
      </div>
    </div>
  </section>

  <!-- Ø·Ù„Ø¨ Ø³Ø­Ø¨ ÙŠØ¯ÙˆÙŠ -->
  <section class="card">
    <h2>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</h2>
    <form method="POST" action="{{ url_for('withdraw') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row">
        <div>
          <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input type="number" name="withdraw_amount" min="1" step="0.01" required>
        </div>
        <div>
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <select name="withdraw_currency" required>
            {% for cur in supported %}<option value="{{ cur }}">{{ cur }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>Ø¨Ø±ÙŠØ¯ Ø¬Ù‡Ø© Ø§Ù„Ø³Ø­Ø¨ (Ù…Ø«Ø§Ù„: PayPal Ø£Ùˆ Ø¨Ù†Ùƒ)</label>
          <input type="email" name="paypal_email" placeholder="you@example.com" required>
        </div>
      </div>
      <div style="margin-top:10px">
        <button type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>
      </div>
      <p class="muted">Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø­Ø¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚.</p>
    </form>
  </section>
</main>

<script>
(function(){
  const bpBtn = document.getElementById('binance-pay');
  const amtInput = document.getElementById('bp_amount');
  const cryptoSel = document.getElementById('bp_crypto');

  // Ø§Ø¬Ù„Ø¨ ØªÙˆÙƒÙ† CSRF Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ø¨Ø± Jinja
  const CSRF = "{{ csrf_token() }}";

  function getAmount(){
    const v = parseFloat(amtInput.value || '0');
    return (isFinite(v) && v > 0) ? v.toFixed(8) : null;
  }

  bpBtn?.addEventListener('click', async () => {
    const amount = getAmount();
    if (!amount){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ (> 0)'); return; }
    if (bpBtn.disabled) return;

    const old = bpBtn.textContent;
    bpBtn.disabled = true;
    bpBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨...';

    try{
      const res = await fetch("{{ url_for('binance_create_order') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": CSRF         // â† Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§
        },
        credentials: "same-origin",   // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆÙƒÙŠ
        body: JSON.stringify({ amount: parseFloat(amount), crypto: cryptoSel.value })
      });

      const data = await res.json().catch(()=> ({}));

if (!res.ok || !data.ok) {
  const code = data?.error || (res.status + "");
  const extra = data?.detail ? "\n" + JSON.stringify(data.detail) : "";
  alert(`ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Binance Pay.\nError: ${code}${extra}`);
  bpBtn.disabled = false; bpBtn.textContent = old;
  return;
}
      if (!data.ok || !data.url){
        alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Binance Pay.');
        bpBtn.disabled = false; bpBtn.textContent = old;
        return;
      }

      window.location = data.url; // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø¹Ù„Ù‰ Binance
    }catch(e){
      console.error(e);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ø«Ù†Ø§Ø¡ Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙØ¹.');
      bpBtn.disabled = false; bpBtn.textContent = old;
    }
  });
})();
</script>
</body>
</html>
