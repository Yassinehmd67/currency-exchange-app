<!DOCTYPE html>
<html lang="{{ session.get('lang','ar') }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ t('user_dashboard') }}</title>
  <style>
    body{font-family:system-ui,"Cairo",sans-serif;margin:0;background:#f7f7f9;
         direction: {{ 'rtl' if session.get('lang','ar')=='ar' else 'ltr' }};}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#111;color:#fff}
    header a{color:#9ad; text-decoration:none; margin-inline:8px}
    main{max-width:980px;margin:24px auto; padding:0 12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border:1px solid #e8e8ef;border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    h1,h2{margin:6px 0 12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
    .muted{opacity:.8;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{display:block;margin-bottom:4px;font-size:14px}
    input,select,button{padding:10px;border:1px solid #ddd;border-radius:8px;font:inherit}
    button{cursor:pointer}
    .top-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .lang{font-size:13px;opacity:.9}
    .ok{color:#1a7f37}.err{color:#b54708}
    .btns{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){.split{grid-template-columns:1fr 1fr}}
    .badge{display:inline-block;background:#eef;padding:2px 8px;border-radius:999px;font-size:12px}
    .warn{padding:8px;border:1px solid #f3c; background:#fff0f6;border-radius:10px}
    .btn-plain{border:1px solid #111;background:#111;color:#fff;border-radius:8px;padding:10px 12px}
    .btn-plain[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
<header>
  <div class="top-links">
    <a href="{{ url_for('index') }}">üè† {{ t('home') }}</a>
    {% if session.get('is_admin') %}
      <a href="{{ url_for('admin_overview') }}">üõ°Ô∏è {{ t('admin_panel') }}</a>
      <a href="{{ url_for('admin_withdrawals') }}">üí∏ {{ t('withdrawals') }}</a>
    {% endif %}
  </div>
  <div class="top-links">
    <span class="lang">
      <a href="{{ url_for('set_lang', lang='ar', next=request.full_path) }}">{{ t('arabic') }}</a> |
      <a href="{{ url_for('set_lang', lang='en', next=request.full_path) }}">{{ t('english') }}</a>
    </span>
    <a href="{{ url_for('logout') }}">üîì {{ t('logout') }}</a>
  </div>
</header>

<main>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="card" aria-live="polite">
        {% for cat,msg in messages %}
          <div class="{{ 'ok' if cat=='success' else 'err' if cat=='error' else '' }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="grid">
    <!-- ÿßŸÑÿ±ÿµŸäÿØ -->
    <section class="card">
      <h2>üí∞ {{ t('your_balances') }}</h2>
      <table>
        <thead><tr><th>{{ t('currency') }}</th><th>{{ t('balance') }}</th></tr></thead>
        <tbody>
          {% for cur,amt in (balances or {}).items() %}
          <tr><td>{{ cur }}</td><td>{{ '%.2f'|format(amt) }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="muted">{{ t('pending_withdrawals_count') }}: {{ pending_withdrawals_count or 0 }}</p>
    </section>

    <!-- ŸÖÿπÿßŸÖŸÑÿßÿ™ ÿ£ÿÆŸäÿ±ÿ© -->
    <section class="card">
      <h2>üìú {{ t('recent_transactions') }}</h2>
      <table>
        <thead><tr><th>{{ t('time') }}</th><th>{{ t('type') }}</th><th>{{ t('amount') }}</th><th>{{ t('currency') }}</th></tr></thead>
        <tbody>
          {% for trow in transactions %}
          <tr>
            <td>{{ trow.timestamp }}</td>
            <td>{{ trow.type }}</td>
            <td>{{ trow.amount }}</td>
            <td>{{ trow.currency }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="muted">{{ t('no_transactions_yet') }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </div>

  <!-- ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸäŸÜ ÿßŸÑÿπŸÖŸÑÿßÿ™ -->
  <section class="card">
    <h2>üîÅ {{ t('convert_between_currencies') }}</h2>
    <form method="POST" action="{{ url_for('convert_balance') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row">
        <div>
          <label>{{ t('from') }}</label>
          <select name="from_currency" required>
            {% for cur in supported %}<option value="{{ cur }}">{{ cur }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>{{ t('to') }}</label>
          <select name="to_currency" required>
            {% for cur in supported %}<option value="{{ cur }}">{{ cur }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>{{ t('amount') }}</label>
          <input type="number" name="amount" min="0" step="0.01" required>
        </div>
      </div>
      <div style="margin-top:10px">
        <button type="submit">{{ t('convert') }}</button>
      </div>
    </form>
  </section>

  <!-- ÿ¥ÿ≠ŸÜ ÿπÿ®ÿ± Binance Pay ŸÅŸÇÿ∑ -->
  <section class="card">
    <h2>üü° {{ t('binance_pay_topup_title') }}</h2>
    {% if not binance_enabled %}
      <div class="warn">‚ö†Ô∏è {{ t('binance_not_configured_warn') }}</div>
    {% endif %}
    <div class="split">
      <form class="row" onsubmit="return false">
        <div>
          <label>{{ t('crypto_currency') }}</label>
          <select id="bp_crypto">
            <option value="USDT">USDT</option>
            <option value="BTC">BTC</option>
          </select>
        </div>
        <div>
          <label>{{ t('amount_to_pay') }}</label>
          <input type="number" id="bp_amount" min="0.5" step="0.00000001" required>
        </div>
      </form>
      <div>
        <span class="badge">{{ t('secure_payment_on_binance') }}</span>
        <div class="btns" style="margin-top:10px">
          <button id="binance-pay" type="button" class="btn-plain" {{ 'disabled' if not binance_enabled else '' }}>üü° {{ t('pay_with_binance_pay') }}</button>
        </div>
        <p class="muted">{{ t('after_payment_note') }}</p>
      </div>
    </div>
  </section>

  <!-- ÿ∑ŸÑÿ® ÿ≥ÿ≠ÿ® ŸäÿØŸàŸä -->
  <section class="card">
    <h2>üí∏ {{ t('withdraw_request') }}</h2>
    <form method="POST" action="{{ url_for('withdraw') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row">
        <div>
          <label>{{ t('amount') }}</label>
          <input type="number" name="withdraw_amount" min="1" step="0.01" required>
        </div>
        <div>
          <label>{{ t('currency') }}</label>
          <select name="withdraw_currency" required>
            {% for cur in supported %}<option value="{{ cur }}">{{ cur }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>{{ t('payout_email_placeholder') }}</label>
          <input type="email" name="paypal_email" placeholder="you@example.com" required>
        </div>
      </div>
      <div style="margin-top:10px">
        <button type="submit">{{ t('send_withdraw_request') }}</button>
      </div>
      <p class="muted">{{ t('withdraw_manual_note') }}</p>
    </form>
  </section>
</main>

<script>
(function(){
  const bpBtn = document.getElementById('binance-pay');
  const amtInput = document.getElementById('bp_amount');
  const cryptoSel = document.getElementById('bp_crypto');

  function getAmount(){
    const v = parseFloat(amtInput.value || '0');
    return (isFinite(v) && v > 0) ? v.toFixed(8) : null;
  }

  bpBtn?.addEventListener('click', async () => {
    const amount = getAmount();
    if (!amount){ alert('{{ t("enter_valid_amount") }}'); return; }
    bpBtn.disabled = true; const old = bpBtn.textContent; bpBtn.textContent = '‚è≥ {{ t("creating_order") }}';
    try{
      const res = await fetch("{{ url_for('binance_create_order') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: parseFloat(amount), crypto: cryptoSel.value })
      });
      const data = await res.json();
      if (!data.ok || !data.url){
        console.error('Binance create order error:', data);
        alert('{{ t("binance_create_failed") }}');
        bpBtn.disabled = false; bpBtn.textContent = old;
        return;
      }
      window.location = data.url; // ÿßŸÑÿØŸÅÿπ ÿπŸÑŸâ Binance
    }catch(e){
      alert('{{ t("network_error_start_payment") }}');
      bpBtn.disabled = false; bpBtn.textContent = old;
    }
  });
})();
</script>
</body>
</html>
